# Questo file definisce l'intera architettura e come i container interagiscono tra loro.

version: '3.8'

services:
  # 1. Il Broker MQTT (Il postino)
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto_broker
    ports:
      - "1883:1883"     # Porta per i dispositivi
      - "9001:9001"     # Porta per WebSockets (opzionale)
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    # Configurazione rapida per accettare connessioni anonime (solo per test locale)
    command: ["mosquitto", "-c", "/mosquitto-no-auth.conf"] 
    entrypoint: 
      - sh
      - -c
      - |
        echo "listener 1883" > /mosquitto-no-auth.conf
        echo "allow_anonymous true" >> /mosquitto-no-auth.conf
        /usr/sbin/mosquitto -c /mosquitto-no-auth.conf

  # 2. Il Simulatore Caldaia (Il nostro script)
  ot-thing-simulator:
    build: .  # Dice a Docker: "Cerca un Dockerfile nella cartella corrente e costruisci l'immagine da lì".
    container_name: caldaia_simulator
    depends_on:  # Dice a Docker: "Cerca di avviare Mosquitto prima di me". 
    # Nota: questo controlla solo l'ordine di avvio, non se Mosquitto è pronto a ricevere connessioni
      - mosquitto
    restart: always

    # ... (i tuoi servizi mosquitto e ot-thing-simulator restano uguali)

  # 3. LiteLLM Proxy (Il Gateway)
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: litellm_proxy
    ports:
      - "4000:4000" # Porta esposta per Home Assistant
    volumes:
      - ./litellm_config.yaml:/app/config.yaml # Montiamo il file creato sopra
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY} # La chiave API (la inseriremo in un file .env)
    command: [ "--config", "/app/config.yaml", "--port", "4000", "--detailed_debug" ]
    restart: always

  # 4. Home Assistant (Il Cervello)
  homeassistant:
    image: lscr.io/linuxserver/homeassistant:latest
    container_name: homeassistant
    ports:                
      - "8123:8123"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Rome
    volumes:
      - ./ha_config:/config 
    restart: always

volumes:
  mosquitto_data:
  mosquitto_log: