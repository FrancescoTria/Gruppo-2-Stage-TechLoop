# Questo file definisce l'intera architettura e come i container interagiscono tra loro.

version: '3.8'

services:
  # 1. Il Broker MQTT (Il postino)
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto_broker
    ports:
      - "1883:1883"     # Porta per i dispositivi
      - "9001:9001"     # Porta per WebSockets (opzionale)
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    # Configurazione rapida per accettare connessioni anonime (solo per test locale)
    command: ["mosquitto", "-c", "/mosquitto-no-auth.conf"] 
    entrypoint: 
      - sh
      - -c
      - |
        echo "listener 1883" > /mosquitto-no-auth.conf
        echo "allow_anonymous true" >> /mosquitto-no-auth.conf
        /usr/sbin/mosquitto -c /mosquitto-no-auth.conf

  # 2. Il Simulatore Caldaia (Il nostro script)
  ot-thing-simulator:
    build: .  # Dice a Docker: "Cerca un Dockerfile nella cartella corrente e costruisci l'immagine da lì".
    container_name: caldaia_simulator
    depends_on:  # Dice a Docker: "Cerca di avviare Mosquitto prima di me". 
    # Nota: questo controlla solo l'ordine di avvio, non se Mosquitto è pronto a ricevere connessioni
      - mosquitto
    restart: always

  # 3. LiteLLM Proxy (Il Gateway)
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: litellm_proxy
    ports:
      - "4000:4000" # Porta esposta per Home Assistant
    volumes:
      - ./litellm_config.yaml:/app/config.yaml # Montiamo il file creato sopra
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY} # La chiave API (la inseriremo in un file .env)
    command: [ "--config", "/app/config.yaml", "--port", "4000", "--detailed_debug" ]
    restart: always

 # 4. Matter Server
  matter-server:
    image: ghcr.io/home-assistant-libs/python-matter-server:stable
    container_name: matter_server
    security_opt:
      - apparmor:unconfined
    volumes:
      - matter_data:/data
      - /run/dbus:/run/dbus:ro  # CRUCIALE: Permette l'accesso al Bluetooth del PC Host
    restart: unless-stopped

# --- CONFIGURAZIONE RETE FUTURA ---
    # Quando userai un dispositivo REALE, togli il commento (#) alla riga sotto 
    # e commenta la sezione 'ports'. Questo permetterà al server di "vedere" la rete locale (mDNS).

    # network_mode: host
    ports:
      - "5580:5580"
      
    command: >
      --storage-path /data
      --primary-interface eth0
      --port 5580

  # 5. Home Assistant (Il Cervello)
  homeassistant:
    image: lscr.io/linuxserver/homeassistant:latest
    container_name: homeassistant
    ports:                
      - "8123:8123"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Rome
    volumes:
      - ./ha_config:/config 
    depends_on:
      - matter-server
      - mosquitto
    restart: always

  # 6. Whisper (Orecchie - Speech to Text)
  whisper:
    image: rhasspy/wyoming-whisper
    container_name: whisper
    command: --model tiny-int8 --language it
    volumes:
      - ./wyoming:/data
    ports:
      - "10300:10300"
    restart: unless-stopped

  # 7. Piper (Bocca - Text to Speech)
  piper:
    image: rhasspy/wyoming-piper
    container_name: piper
    command: --voice it_IT-paola-medium
    volumes:
      - ./wyoming:/data
    ports:
      - "10200:10200"
    restart: unless-stopped

volumes:
  mosquitto_data:
  mosquitto_log:
  matter_data: