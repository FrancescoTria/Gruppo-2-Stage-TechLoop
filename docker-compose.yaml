# Questo file definisce l'intera architettura e come i container interagiscono tra loro.

version: "3.8"

services:
  # 1. Broker MQTT (il "postino")
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto_broker
    ports:
      - "1883:1883"     # Porta per i dispositivi
      - "9001:9001"     # Porta per WebSockets (opzionale)
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log
    # Configurazione rapida per accettare connessioni anonime (solo per test locale)
    command: ["mosquitto", "-c", "/mosquitto-no-auth.conf"]
    entrypoint:
      - sh
      - -c
      - |
        echo "listener 1883" > /mosquitto-no-auth.conf
        echo "allow_anonymous true" >> /mosquitto-no-auth.conf
        /usr/sbin/mosquitto -c /mosquitto-no-auth.conf

  # 2. Simulatore Caldaia
  ot-thing-simulator:
    build: .
    container_name: caldaia_simulator
    depends_on:
      - mosquitto
    restart: always

  # 3. LiteLLM Proxy (Gateway verso Ollama)
  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: litellm_proxy
    ports:
      - "4000:4000"
    volumes:
      - ./litellm_config.yaml:/app/config.yaml
    depends_on:
      - ollama
    command: ["--config", "/app/config.yaml", "--port", "4000", "--detailed_debug"]
    restart: always

  # 4. Ollama (LLM locale)
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    # Per GPU NVIDIA, scommenta questo blocco
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]
    restart: always

  # 5. Matter Server
  matter-server:
    image: ghcr.io/home-assistant-libs/python-matter-server:stable
    container_name: matter_server
    security_opt:
      - apparmor:unconfined
    volumes:
      - matter_data:/data
      - /run/dbus:/run/dbus:ro
    restart: unless-stopped

    # --- CONFIGURAZIONE RETE FUTURA ---
    # Quando userai un dispositivo reale, togli il commento alla riga sotto
    # e commenta la sezione ports. Questo permetterÃ  al server di vedere la rete locale (mDNS).
    # network_mode: host

    ports:
      - "5580:5580"

    command: >
      --storage-path /data
      --primary-interface eth0
      --port 5580

  # 6. Home Assistant
  homeassistant:
    image: lscr.io/linuxserver/homeassistant:latest
    container_name: homeassistant
    ports:
      - "8123:8123"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Rome
    volumes:
      - ./ha_config:/config
    depends_on:
      - matter-server
      - mosquitto
      - litellm
    restart: always

  # 7. Whisper (Speech to Text)
  whisper:
    image: rhasspy/wyoming-whisper
    container_name: whisper
    command: --model tiny-int8 --language it
    volumes:
      - ./wyoming:/data
    ports:
      - "10300:10300"
    restart: unless-stopped

  # 8. Piper (Text to Speech)
  piper:
    image: rhasspy/wyoming-piper
    container_name: piper
    command: --voice it_IT-paola-medium
    volumes:
      - ./wyoming:/data
    ports:
      - "10200:10200"
    restart: unless-stopped

  # 9. PocketBase (DB tipo "tabelle")
  pocketbase:
    image: ghcr.io/muchobien/pocketbase:latest
    container_name: pocketbase
    restart: unless-stopped
    ports:
      - "8090:8090"
    volumes:
      - ./pb_data:/pb_data
    command: ["--dir", "/pb_data", "--http", "0.0.0.0:8090"]

volumes:
  mosquitto_data:
  mosquitto_log:
  matter_data:
  ollama_data:
